<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snowplowing App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Arial', sans-serif;
        background-color: #4e8dff;
        color: #fff;
    }

    #map-container {
        display: flex;
        flex-direction: column;
        height: 80vh;
        margin: 20px;
    }

    #map {
        flex: 1;
    }

    #controls {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

    button {
        cursor: pointer;
        padding: 10px;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s, transform 0.3s;
        color: #fff;
    }

    #start-stop-button {
        background-color: #4CAF50;
    }

    #start-stop-button.stop {
        background-color: #f44336;
    }

    #pause-button {
        background-color: #808080;
    }

    #pause-button.continue {
        background-color: #f44336;
    }

    #logs-button {
        background-color: #4CAF50;
    }

    #close-button {
        background-color: #f44336;
        margin-top: 10px;
        padding: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        color: white;
    }

    #close-button:hover {
        background-color: #d32f2f; /* Darken the color on hover */
    }

    #info-container {
        margin-top: 10px;
        font-size: 16px;
        text-align: center;
        color: #000; /* Change text color to black */
    }

    #info-container strong {
        color: #333;
    }

    #time-used,
    #kilometers {
        display: inline-block;
        margin-top: 5px;
        padding: 8px;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-width: 80px;
        color: #000; /* Change text color to black */
    }

    #time-used {
        margin-right: 10px;
    }

    #logs-tab {
        display: none;
        flex-direction: column;
        background-color: #f5f5f5;
        border: 1px solid #ccc;
        padding: 10px;
        max-height: 60vh;
        overflow-y: auto;
        margin-top: 20px;
        color: #000; /* Change text color to black */
    }

    #logs-header {
        color: #333;
        margin-bottom: 10px;
    }

    #logsList {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    #logsList li {
        margin-bottom: 5px;
    }

    #logsList li:before {
        content: '\2022';
        color: #4CAF50;
        margin-right: 5px;
    }
</style>


</head>
<body>

<div id="map-container">
    <div id="map"></div>
    <div id="controls">
        <button id="start-stop-button" onclick="toggleRecording()">Start</button>
        <button id="pause-button" onclick="togglePause()">Pause</button>
        <button id="logs-button" onclick="toggleLogs()">Logs</button>
    </div>
    <div id="info-container">
        <div><strong>Time Used:</strong> <span id="time-used">0 min 0 sec</span></div>
        <div><strong>Kilometers:</strong> <span id="kilometers">0.00 km</span></div>
    </div>
    <div id="logs-tab">
        <h2 id="logs-header">Logs</h2>
        <ul id="logsList"></ul>
        <button id="close-button" onclick="toggleLogs()">Close</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([0, 0], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var recording = false;
    var paused = false;
    var routeData = {
        startTimestamp: 0,
        lastTimestamp: 0,
        pauseDuration: 0,
        distance: 0,
        trail: []
    };

    var currentLocationMarker = L.circleMarker([0, 0], { color: 'blue' }).addTo(map);

    var startStopButton = document.getElementById('start-stop-button');
    var pauseButton = document.getElementById('pause-button');
    var timeUsedElement = document.getElementById('time-used');
    var kilometersElement = document.getElementById('kilometers');
    var logsTab = document.getElementById('logs-tab');

    function toggleRecording() {
        recording = !recording;

        if (recording) {
            startRecording();
            startStopButton.textContent = 'Stop';
            startStopButton.classList.add('stop');
            updateInfo();
        } else {
            stopRecording();
            startStopButton.textContent = 'Start';
            startStopButton.classList.remove('stop');
            resetInfo();
        }
    }

    function togglePause() {
        if (recording) {
            paused = !paused;

            if (paused) {
                pauseRecording();
                pauseButton.textContent = 'Continue';
                pauseButton.classList.add('continue');
            } else {
                continueRecording();
                pauseButton.textContent = 'Pause';
                pauseButton.classList.remove('continue');
            }
        }
    }

    function startRecording() {
        routeData.startTimestamp = Date.now();
        routeData.lastTimestamp = Date.now();
        routeData.pauseDuration = 0;
        routeData.trail = [];
        getLocation();
        updateTimeInterval = setInterval(updateTime, 1000);
        updateViewInterval = setInterval(updateView, 3000);

        // Zoom in on the person driving
        map.flyTo(currentLocationMarker.getLatLng(), 17, {
            animate: true,
            duration: 2
        });
    }

    function continueRecording() {
        routeData.lastTimestamp = Date.now();
        getLocation();
        updateTimeInterval = setInterval(updateTime, 1000);
        updateViewInterval = setInterval(updateView, 3000);
    }

    function pauseRecording() {
        clearInterval(updateTimeInterval);
        clearInterval(updateViewInterval);
    }

    function stopRecording() {
        // Save route data and display in logs
        saveToLogs(routeData);
        routeData = {
            startTimestamp: 0,
            lastTimestamp: 0,
            pauseDuration: 0,
            distance: 0,
            trail: []
        };
        clearInterval(updateTimeInterval);
        clearInterval(updateViewInterval);

        // Check if there is a trail before attempting to calculate bounds
        if (routeData.trail.length > 0) {
            // Zoom out to show the entire recorded path
            var bounds = new L.LatLngBounds(routeData.trail);
            map.flyToBounds(bounds, {
                animate: true,
                duration: 2
            });
        }

        // Show logs tab
        logsTab.style.display = 'flex';

        // Reset Start/Stop button to default state
        startStopButton.textContent = 'Start';
        startStopButton.classList.remove('stop');
    }

    function getLocation() {
        if (navigator.geolocation) {
            var firstLocationUpdate = true; // Added variable to track the first location update

            navigator.geolocation.watchPosition(
                function (position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;

                    // Update current location marker
                    currentLocationMarker.setLatLng([lat, lon]);

                    // Add current location to the trail
                    if (recording) {
                        routeData.trail.push([lat, lon]);
                        calculateDistance();
                    }

                    // Automatically zoom in on the person's location after the first update
                    if (firstLocationUpdate) {
                        map.flyTo([lat, lon], 17, {
                            animate: true,
                            duration: 2
                        });
                        firstLocationUpdate = false; // Set to false to prevent further automatic zooming
                    }
                },
                function (error) {
                    console.error("Error getting location:", error.message);
                }
            );
        } else {
            alert("Geolocation is not supported by your browser");
        }
    }

    function saveToLogs(data) {
        var logsList = document.getElementById('logsList');
        var listItem = document.createElement('li');
        listItem.textContent = `Route: ${data.distance.toFixed(2)} km, Time: ${formatTime(data.pauseDuration)}`;
        logsList.appendChild(listItem);
    }

    function formatTime(milliseconds) {
        var seconds = Math.floor(milliseconds / 1000);
        var minutes = Math.floor(seconds / 60);
        var hours = Math.floor(minutes / 60);

        seconds %= 60;
        minutes %= 60;

        var formattedTime = '';

        if (hours > 0) {
            formattedTime += hours + ' hr ';
        }

        if (minutes > 0 || hours > 0) {
            formattedTime += minutes + ' min ';
        }

        formattedTime += seconds + ' sec';

        return formattedTime.trim();
}


    function toggleLogs() {
        // Toggle between logs tab and controls
        if (logsTab.style.display === 'none') {
            logsTab.style.display = 'flex';
            map.style.display = 'none';
        } else {
            logsTab.style.display = 'none';
            map.style.display = 'flex';
        }
    }


    function updateTime() {
        if (recording && !paused) {
            var currentTime = Date.now();
            routeData.pauseDuration += currentTime - routeData.lastTimestamp;
            routeData.lastTimestamp = currentTime;

            // Update time used and kilometers
            timeUsedElement.textContent = formatTime(routeData.pauseDuration);
            kilometersElement.textContent = routeData.distance.toFixed(2) + ' km';
        }
    }

    function calculateDistance() {
        if (routeData.trail.length > 1) {
            var lastPoint = routeData.trail[routeData.trail.length - 2];
            var currentPoint = routeData.trail[routeData.trail.length - 1];
            var distance = calculateDistanceBetweenPoints(lastPoint, currentPoint);
            routeData.distance += distance;
        }
    }

    function calculateDistanceBetweenPoints(point1, point2) {
        var lat1 = point1[0];
        var lon1 = point1[1];
        var lat2 = point2[0];
        var lon2 = point2[1];

        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var distance = R * c; // Distance in km
        return distance;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180);
    }

    function updateStrengthBar(accuracy) {
        var bars = Math.min(5, Math.ceil(5 - (accuracy / 50)));
        strengthBar.innerHTML = '';

        if (accuracy === 0) {
            // No location signal
            strengthBar.innerHTML = 'No Location';
        } else {
            // Display strength bars
            for (var i = 0; i < bars; i++) {
                var bar = document.createElement('div');
                bar.className = 'strength-bar';
                strengthBar.appendChild(bar);
            }
        }
    }

    function updateView() {
        if (recording) {
            map.flyTo(currentLocationMarker.getLatLng(), 17, {
                animate: true,
                duration: 2
            });
        }
    }

    function updateInfo() {
        updateInfoInterval = setInterval(function () {
            timeUsedElement.textContent = formatTime(routeData.pauseDuration);
            kilometersElement.textContent = routeData.distance.toFixed(2) + ' km';
        }, 1000);
    }

    function resetInfo() {
        clearInterval(updateInfoInterval);
        timeUsedElement.textContent = '0 min 0 sec';
        kilometersElement.textContent = '0.00 km';
    }
</script>

</body>
</html>
